"use strict";angular.module("capseq",["angular-multi-select","smart-table"]),angular.module("capseq").controller("GenomeController",["$scope","$rootScope","$http","$q","dataLoader",function(a,b,c,d,e){function f(a,b){for(var c=!1,d=0;d<b.hit.length;++d)b.hit[d].isSuperGroup&&(c=!0);c?b.setTitle("Gene: "+a.geneId):(b.setTitle("Transcript: "+a.label),b.add("Transcript ID",a.label),b.add("Transcript biotype",a.method)),b.add("Gene ID",a.geneId),b.add("Gene name",a.geneName),b.add("Gene biotype",a.geneBioType),c||b.add("Transcript attributes",a.tags)}a.input_data=[],a.output_data=[],a.displayed_region=[],a.availableSnps=[],a.snpid={value:""},a.regionToTx={},a.regionToDisease=[],a.region=[],a.selectedregion={},a.associatedtable=[];var g="https://pwbc.garvan.org.au/~xiuque/captureseq-data/output/",h=[],i=new Browser({chr:"1",viewStart:150727097,viewEnd:150875437,noPersist:!0,coordSystem:{speciesName:"Human",taxon:9606,auth:"NCBI",version:"36",ucscName:"hg19"},browserLinks:{Ensembl:"http://www.ensembl.org/Homo_sapiens/Location/View?r=${chr}:${start}-${end}",UCSC:"http://genome.ucsc.edu/cgi-bin/hgTracks?db=hg38&position=chr${chr}:${start}-${end}",Sequence:"http://www.derkholm.net:8080/das/hg38comp/sequence?segment=${chr}:${start},${end}"},sources:[{name:"Genome",twoBitURI:g+"hg19.2bit",tier_type:"sequence",pinned:!0,provides_entrypoints:!0},{name:"GENCODE version 19",bwgURI:g+"gencode.v19.annotation.bb",collapseSuperGroups:!0,trixURI:g+"gencode.v19.annotation.ix",noSourceFeatureInfo:!0,featureInfoPlugin:f},{name:"GWAS Snps",bwgURI:g+"gwas_snp.bb"},{name:"Capture Region - Tissue",bwgURI:g+"captured_region_tissue.bb"},{name:"Capture Region - Melanoma",bwgURI:g+"captured_region_melanoma.bb"},{name:"Capture Transcripts - Tissue",bwgURI:g+"captured_transcript_tissue_single_noex.bb",featureInfoPlugin:function(b,c){e.getTranscriptChangeInfo(b.label,c,"tissue").then(function(b){a.transcript_data=b.transcriptData,a.$broadcast("expression_change",b.expressionData)})}},{name:"Capture Transcripts - Melanoma",bwgURI:g+"captured_transcript_melanoma_single_noex.bb",featureInfoPlugin:function(b,c){e.getTranscriptChangeInfo(b.label,c,"melanoma").then(function(b){a.transcript_data=b.transcriptData,a.$broadcast("expression_change",b.expressionData)})}}]});a.$on("browserchanged",function(b,c,d){angular.isDefined(d)?i.setLocation(d.chr.toString(),d.start,d.end):i.setLocation(c.chr.toString(),c.start,c.end);var e=a.regionToDisease.filter(function(a,b,d){return a.captured_region===c.loci_id}),f=e.map(function(b,c,d){var e=angular.copy(h[b.disease_id]);return e.snp=b.snp,e.pubmed=b.pubmed,e.pvalue=b.pvalue,e.snplocation=angular.copy(a.snpSpecificLocation[b.snp]),e});c.details=f,a.selectedregion=c}),e.loadDefault().then(function(b){var c=[],d=b.expression.data.expression;a.transcript_data=b.txinfo.data,a.transcript_data.track="melanoma",a.region=b.regionList.data,a.$broadcast("expression_change",d),a.$broadcast("region_change",b.regionList.data),a.selectedregion={chr:1,start:150534367,end:150960349,"Region Width":425983,track:"melanoma",details:[{snp:"rs7412746",disease:"melanoma",pvalue:"-"}]},angular.forEach(a.region,function(a,b){c=c.concat(a.details)}),a.availableSnps=_.uniq(c)}),e.getDiseases().then(function(b){var c=[],d=e.getEfoToDiseaseMap();angular.forEach(b,function(a,b){var e=[];angular.forEach(a,function(a,b){this.push({text:a,value:d[a],id:a,checked:!0})},e),c.push({text:b,value:b+"_parent",id:b,children:e,isParent:!0})}),a.input_data=c,h=e.getTraitsByDiseaseId()}),e.getSnpsByLoci().then(function(b){a.regionToDisease=b}),e.getSnpSpecificLocation().then(function(b){a.snpSpecificLocation=b}),a.$on("ams_output_model_change",function(b,c){var d=[];angular.forEach(a.output_data,function(a,b){d=d.concat(a.value)}),d=_.uniq(d);var e=a.regionToDisease.filter(function(a,b,c){return-1!==d.indexOf(a.disease_id)});e=e.map(function(a,b){return a.captured_region}),a.displayed_region=_.uniq(e)}),a.snpChanged=function(b){var c=a.regionToDisease.filter(function(a,c,d){return a.snp===b}),d=a.region.filter(function(a,b,d){return a.loci_id===c[0].captured_region});if(!_.isEmpty(d)){var e=a.snpSpecificLocation[b];a.$broadcast("goToSnp",d[0].loci_id),a.$emit("browserchanged",d[0],e)}}}]),angular.module("capseq").directive("barChart",function(){return{restrict:"E",scope:{data:"=data",transcript_id:"="},link:function(a,b,c){function d(a){d3.select(".expression_plot").remove();var b=d3.scale.ordinal().rangeRoundBands([0,f],.1),c=d3.scale.linear().range([g,0]);b.domain(a.map(function(a){return a.label})),c.domain([0,1.1*d3.max(a,function(a){return Number(a.value)})]);var d=d3.svg.axis().scale(b).orient("bottom"),h=d3.svg.axis().scale(c).orient("left"),i=d3.select("#expression").append("svg").attr("width",f+e.left+e.right).attr("height",g+e.top+e.bottom).attr("class","expression_plot").append("g").attr("transform","translate("+e.left+","+e.top+")");i.append("g").attr("class","x axis").attr("transform","translate(0,"+g+")").call(d).selectAll("text").attr("y",0).attr("x",9).attr("dy",".35em").attr("transform","rotate(90)").style("text-anchor","start"),i.append("g").attr("class","y axis").call(h).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Expression (FPKM)"),i.selectAll(".bar").data(a).enter().append("rect").attr("class","bar").attr("x",function(a){return b(a.label)}).attr("width",b.rangeBand()).attr("y",function(a){return c(Number(a.value))}).attr("height",function(a){return g-c(Number(a.value))})}var e={top:20,right:20,bottom:30,left:40},f=520-e.left-e.right,g=300-e.top-e.bottom;a.$on("expression_change",function(a,b){d(b)})}}}),angular.module("capseq").directive("genomeNavigator",function(){return{restrict:"E",template:'<button id="zoom_in" type="button" class="btn btn-default  btn-xs"  ng-click="svg_zoom_in()"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button><button id="zoom_out" type="button" class="btn btn-default btn-xs" ng-click="svg_zoom_out()"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button><button id="refresh" type="button" class="btn btn-default  btn-xs" ng-click="svg_zoom_refresh()"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>',scope:{region:"=",selectedregion:"=",snpToLoci:"<",displayedRegion:"<"},link:function(a,b,c){function d(a){d3.selectAll("rect.feature").each(function(b,c){"undefined"!=typeof b&&(-1!==a.indexOf(b.loci_id)?d3.select(this).classed("filtered",!1):d3.select(this).classed("filtered",!0))})}a.$watch("displayedRegion",function(a,b){d(a)}),a.$on("region_change",function(c,d){function e(){function c(){w.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),u.select(".y.axis").call(t),u.select(".x.axis").call(s)}function e(a){return"translate("+m(a.start)+","+n(a.chr)+")"}function f(a){var b=4,c=d3.transform(a.attr("transform")),d=c.translate[0],e=c.translate[1];console.log(c),u.transition().duration(400).call(r.translate([d*-b+o/2,e*-b+p/2]).scale(b).event),u.select(".y.axis").call(t),u.select(".x.axis").call(s)}function h(a){d3.selectAll(".selected").classed("selected",!1),a.classed("selected",!0),f(a)}var j=$(b).parent().width(),k={top:20,right:20,bottom:30,left:40},o=j-k.left-k.right,p=600-k.top-k.bottom,q=20;m.range([1,o]),n.range([0,p]);var r=d3.behavior.zoom().x(m).y(n).scaleExtent([0,1e4]).on("zoom",c),s=d3.svg.axis().scale(m).orient("bottom").tickSize(-p),t=d3.svg.axis().scale(n).orient("left").tickValues(g.map(function(a){return parseInt(a.chr)})).tickFormat(d3.format("d")).tickSubdivide(0),u=d3.select("#navigator").append("svg").attr("width",o+k.left+k.right).attr("height",p+k.top+k.bottom).attr("class","navigator").append("g").attr("transform","translate("+k.left+","+k.top+")").call(r);u.append("rect").attr("width",o).attr("height",p).style("fill","none").style("pointer-events","all"),u.append("g").classed("y axis",!0).call(t).append("text").attr("transform","rotate(-90)").attr("y",6).style("text-anchor","end").text("Chromosome"),u.append("g").classed("x axis",!0).attr("transform","translate(0,"+(p+k.top)+")").call(s).append("text").classed("label",!0).attr("x",o).attr("y",k.bottom).style("text-anchor","end");var v=u.append("svg").attr("width",o).attr("height",p).attr("id","main");v.append("svg:line").classed("axisLine hAxisLine",!0).attr("x1",0).attr("y1",0).attr("x2",o).attr("y2",0).attr("transform","translate(0,"+p+")"),v.append("svg:line").classed("axisLine vAxisLine",!0).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",p);var w=v.append("g").attr("width",o).attr("height",p).attr("id","mainobjects");w.selectAll(".box").data(i).enter().append("rect").classed("box",!0).attr("transform",e).attr("height",q).attr("width",function(a){return m(a.end)}).style("fill","transparent").style("stroke","black"),w.selectAll(".feature").data(d).enter().append("rect").classed("feature",!0).classed("selected",function(a){return"melanoma"==a.track&&1==a.chr}).attr("transform",e).attr("height",q).attr("id",function(a){return a.loci_id}).attr("width",function(a){return m(a.width)}).style("fill",function(a){return l[a.track]}).on("click",function(b){var c=d3.select(this);h(c),a.$emit("browserchanged",c.datum())}).on("mouseover",function(a){d3.select(this).classed("mouseovered",!0)}).on("mouseout",function(a){d3.select(this).classed("mouseovered",!1)});var x=angular.copy(d3.transform(d3.select("#mainobjects").attr("transform")).translate);angular.copy(d3.transform(d3.select("#mainobjects").attr("transform")).scale);a.svg_zoom_in=function(){var a=d3.transform(d3.select("#mainobjects").attr("transform")),b=a.scale[0];b=1.5*b,u.transition().duration(400).call(r.scale(b).event),u.select(".y.axis").call(t),u.select(".x.axis").call(s)},a.svg_zoom_out=function(){var a=d3.transform(d3.select("#mainobjects").attr("transform")),b=a.scale[0];console.log(b),b=.5*b,u.transition().duration(400).call(r.scale(b).event),u.select(".y.axis").call(t),u.select(".x.axis").call(s)},a.svg_zoom_refresh=function(){u.transition().duration(400).call(r.translate(x).scale(1).event),u.select(".y.axis").call(t),u.select(".x.axis").call(s)},a.$on("goToSnp",function(a,b){h(d3.select('rect[id="'+b+'"]'))})}var f={1:249250621,2:243199373,3:198022430,4:191154276,5:180915260,6:171115067,7:159138663,8:146364022,9:141213431,10:135534747,11:135006516,12:133851895,13:115169878,14:107349540,15:102531392,16:90354753,17:81195210,18:78077248,20:63025520,19:59128983,22:51304566,21:48129895},g=[];d3.map(d,function(a){a.chr=parseInt(a.chr)});var h=_.groupBy(d,function(a){return a.chr});angular.forEach(h,function(a,b){var c=d3.max(a,function(a){return a.end}),d=d3.min(a,function(a){return a.start});d3.map(a,function(a){a.normalizedStart=a.start-d,a.normalizedEnd=a.end-d}),this.push({chr:b,value:a,max:c,min:d})},g);var i=(d3.max(g,function(a){return d3.max(a.value,function(a){return a.normalizedEnd})}),[]);angular.forEach(f,function(a,b){this.push({chr:b,start:0,end:a})},i);var j=Object.keys(f).map(function(a){return f[a]});j=d3.max(j);var k=d3.max(g.map(function(a){return parseInt(a.chr)})),l={tissue:"#17becf",melanoma:" #d62728"},m=d3.scale.linear(),n=d3.scale.linear();n.domain([1,k]),m.domain([1,j]),window.onresize=function(){a.$apply()},a.$watch(function(){return angular.element(window)[0].innerWidth},function(){d3.select("svg.navigator").remove(),e()})})}}}),angular.module("capseq").directive("autocomplete",function(){return{restrict:"A",scope:{results:"=",suggestions:"<",changeEvent:"&"},link:function(a,b,c){function d(a,b){return-1!==a.indexOf(b)?b:!1}a.$watch("suggestions",function(b,c){console.log(b),$("#refsearch").autocomplete({source:b,focus:function(b,c){a.results.value=d(a.suggestions,c.item.value),a.changeEvent()},select:function(b,c){a.results.value=d(a.suggestions,c.item.value),a.changeEvent()}}),$("#refsearch").keypress(function(b){13==b.keyCode&&(b.preventDefault(),$(this).autocomplete("close"),console.log(this.value),a.results.value=d(a.suggestions,this.value),a.$parent.$apply(),a.changeEvent())})})}}}),angular.module("capseq").service("getTracks",["$http",function(a){}]),angular.module("capseq").controller("regionModalController",function(a,b,c){a.regionDetails=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}),angular.module("capseq").service("defaultSettings",["dataLoader","$http","$q",function(a,b,c){}]).factory("dataLoader",["$http","$q",function(a,b){function c(a){return p.efoToDiseaseId[a]}function d(b){var c="/txinfo/"+b;return a.get(c)}function e(b,c){var d=c+"/"+b;return a.get(d)}function f(a){var b=[];return angular.forEach(a,function(a,b){this.push({label:b,value:a})},b),b}function g(a,c,g){var h=d(a),i=e(a,g);return b.all({txinfo:h,expression:i}).then(function(a){var b=a.txinfo.data;b.track=g;var c=f(a.expression.data.expression);return{transcriptData:b,expressionData:c}})}function h(){var b="/capturedregions/";return a.get(b)}function i(){var a=d("TCONS_00047715"),c=e("TCONS_00047715","melanoma"),g=h();return b.all({txinfo:a,expression:c,regionList:g}).then(function(a){return a.expression.data.expression=f(a.expression.data.expression),a})}function j(){return a.get("/traits/all/").then(function(a){var b={},c=angular.copy(a.data);return angular.forEach(c,function(a,b,c){this[a.disease_id]=a},p.traitsByDiseaseId),p.diseaseMap=a.data,angular.forEach(a.data,function(a,c){b[a.parent_term]=b[a.parent_term]||[],b[a.parent_term].push(a.efo_term)}),angular.forEach(b,function(a,b){this[b]=_.uniq(a)},b),angular.forEach(p.diseaseMap,function(a,b){p.efoToDiseaseId[a.efo_term]=p.efoToDiseaseId[a.efo_term]||[],p.efoToDiseaseId[a.efo_term].push(a.disease_id)}),angular.forEach(p.diseaseMap,function(a,b){this[b]=_.uniq(a)},p.diseaseMap),b})}function k(){return a.get("/snp/").then(function(a){return a.data})}function l(){return a.get("/snp_loc/").then(function(a){var b={};return angular.forEach(a.data,function(a,b,c){this[a.snp_id]={chr:a.chr,start:a.start-9,end:a.end+10}},b),b})}function m(b){return a.get("/capturedregions/transcripts/"+b)+"/".then(function(a){return a.data})}function n(){return p.efoToDiseaseId}function o(){return p.traitsByDiseaseId}var p={};return p.diseaseMap={},p.efoToDiseaseId={},p.traitsByDiseaseId={},{getTranscriptChangeInfo:g,loadDefault:i,getDiseases:j,mapEfoToDiseaseId:c,getEfoToDiseaseMap:n,getSnpsByLoci:k,getRegionToTx:m,getTraitsByDiseaseId:o,getSnpSpecificLocation:l}}]);